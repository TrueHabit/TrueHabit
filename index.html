<!DOCTYPE html>
<html>
<head>
  <!-- Define la codificaci√≥n de caracteres para mostrar s√≠mbolos correctamente -->
  <meta charset="UTF-8">

  <!-- Ajusta la vista en dispositivos m√≥viles con anchura y altura concretas, sin zoom -->
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no">

  <!-- T√≠tulo de la p√°gina que aparece en la pesta√±a del navegador -->
  <title>¬°Despega tus H√°bitos!</title>

  <!-- Script para integraci√≥n con Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* 
      Estilos globales:
      - Se quitan m√°rgenes y rellenos por defecto
      - Se fija la caja de dimensi√≥n seg√∫n border-box
    */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* 
      Html y body ocupan la altura completa, 
      fondo blanco (#fff)
    */
    html, body {
      height: 100%;
      min-height: 100vh;
      background-color: #fff; /* Vuelve a blanco */
      font-family: sans-serif;
      -webkit-overflow-scrolling: touch;
    }

    /* 
      Body en modo flex para ajustar su contenido principal
    */
    body {
      display: flex;
      flex-direction: column;
    }

    /* 
      main crece para ocupar el espacio sobrante 
      y se a√±ade un padding-bottom grande para scroll en m√≥viles
    */
    main {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      padding-bottom: 600px;
    }

    /* 
      T√≠tulos principales
    */
    h1 {
      text-align: center;
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
      color: #f06292;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    .subtitle-cohete {
      text-align: center;
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    .cohete-logo {
      max-width: 180px;
      display: block;
      margin: 0 auto;
    }

    /* 
      input-group para nombre, edad, etc.
    */
    .input-group {
      margin-bottom: 15px;
    }
    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }
    .input-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 6px;
      font-size: 1rem;
    }

    /* 
      Secci√≥n donde se muestran los h√°bitos seleccionados
    */
    #habitosSeleccionadosContainer {
      background-color: #fff;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    #selectedHabitsList {
      font-size: 0.9rem;
      color: #666;
      min-height: 20px;
    }

    /* 
      Acorde√≥n con bordes rosas y fondo blanco
    */
    .accordion {
      border: 2px solid #f06292;
      border-radius: 8px;
      margin-bottom: 10px;
      overflow: hidden;
      background-color: #fff;
    }
    .accordion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      background-color: #fafafa;
      cursor: pointer;
    }
    .accordion-header h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      color: #f06292;
    }
    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .accordion-content.open {
      padding: 15px;
      border-top: 1px solid #eee;
    }

    /* 
      Contenedor de h√°bitos 
    */
    .habit-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
    }
    .habit-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
      background-color: #fff;
    }
    .habit-item:hover {
      background-color: #fdfdfd;
    }
    .habit-item.selected {
      border-color: #ff9090;
      background-color: #ffecee;
    }
    .habit-label {
      display: flex;
      align-items: center;
      gap: 8px;
      pointer-events: none;
    }
    .habit-icon {
      font-size: 1.4rem;
    }
    .plus-btn {
      background-color: transparent;
      border: none;
      font-size: 1.2rem;
      color: #f06292;
      cursor: pointer;
    }

    /* 
      Para a√±adir un h√°bito personalizado
    */
    .custom-habit-wrapper {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      padding: 10px;
      margin-top: 10px;
      border-top: 1px dashed #ddd;
      grid-column: 1 / -1;
    }
    .custom-emoji-input {
      width: 60px;
      text-align: center;
      border: 1px solid #eee;
      border-radius: 6px;
      font-size: 1rem;
      padding: 8px;
    }
    .custom-habit-input {
      flex: 1;
      min-width: 0;
      padding: 8px;
      border: 1px solid #eee;
      border-radius: 6px;
      font-size: 1rem;
    }
    .custom-habit-btn {
      background-color: #f06292;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.6rem 1rem;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .custom-habit-btn:hover {
      background-color: #ec407a;
    }

    /* 
      Secci√≥n de Objetivos 
    */
    #objetivosContainer {
      background-color: #fff;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      margin-bottom: 20px;
    }
    #objetivosList {
      font-size: 0.9rem;
      color: #333;
    }
    .objetivo-row {
      margin-bottom: 15px;
    }
    .objetivo-row label {
      font-weight: 600;
      min-width: 120px;
      display: inline-block;
      margin-bottom: 5px;
    }
    .objetivo-content {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 5px;
      flex-wrap: wrap;
    }
    .objetivo-input {
      flex: 1;
      min-width: 0;
      padding: 8px;
      border: 1px solid #eee;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    .frequency-row {
      margin-left: 30px;
      margin-top: 5px;
    }
    .frequency-select {
      padding: 5px 8px;
      font-size: 0.9rem;
      border-radius: 6px;
      border: 1px solid #eee;
    }

    /* 
      Bot√≥n de env√≠o
    */
    .send-button {
      background-color: #ccc;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.8rem 1.5rem;
      cursor: not-allowed;
      font-size: 1rem;
      display: block;
      margin: 0 auto 40px auto;
      transition: background-color 0.2s;
    }
    .send-button.enabled {
      background-color: #f06292;
      cursor: pointer;
    }
    .send-button.enabled:hover {
      background-color: #ec407a;
    }

    /*
      Mensajes de error
    */
    #errorMessages {
      font-size: 0.7rem;
      color: #d00;
      line-height: 1.2;
      margin-top: 10px;
      text-align: center;
    }

    /*
      Breakpoints
    */
    @media (min-width: 600px) {
      h1 {
        font-size: 2rem;
      }
      .subtitle-cohete {
        margin-bottom: 1.5rem;
      }
    }
    @media (min-width: 768px) {
      .habit-list {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (min-width: 992px) {
      .habit-list {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* ======================================
       MODAL para mensaje de bienvenida
       ====================================== */
    .modal-overlay {
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      /* Por defecto oculto */
      display: none;
    }
    .modal-content {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      max-width: 350px;
      text-align: center;
    }
    .modal-content img {
      max-width: 120px;
      display: block;
      margin: 1rem auto 0 auto;
    }
    .close-modal-btn {
      margin-top: 1rem;
      background: #f06292;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.6rem 1rem;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .close-modal-btn:hover {
      background-color: #ec407a;
    }
  </style>
</head>

<body>
  <main>

    <!-- T√≠tulo principal -->
    <h1>¬°Despega tus H√°bitos!</h1>

    <!-- Logo principal -->
    <div class="subtitle-cohete">
        <img src="truehabits-logo_TRS.png" alt="TrueHabits Logo" class="cohete-logo">
    </div> 

    <!-- Campo Nombre -->
    <div class="input-group">
      <label for="nombre">Nombre *</label>
      <input type="text" id="nombre" placeholder="¬øC√≥mo te llaman tus amigos?">
    </div>
    <!-- Campo Edad -->
    <div class="input-group">
      <label for="edad">Edad *</label>
      <input type="number" id="edad" placeholder="Para un seguimiento personalizado" min="0">
    </div>

    <!-- Campo Sexo -->
    <div class="input-group">
      <label for="sexo">Sexo *</label>
      <select id="sexo" class="frequency-select">
        <option value="no_especificado" selected>Prefiero no decirlo</option>
        <option value="masculino">Masculino</option>
        <option value="femenino">Femenino</option>
      </select>
    </div>

    <!-- Lista de h√°bitos seleccionados -->
    <h2>H√°bitos registrados *</h2>
    <div id="habitosSeleccionadosContainer">
      <div id="selectedHabitsList">(¬°Seleccione alg√∫n H√°bito!)</div>
    </div>

    <!-- Acordeones -->
    <div class="accordion" data-category="Alimentacion">
      <div class="accordion-header">
        <h3>Alimentaci√≥n</h3>
        <span>+</span>
      </div>
      <div class="accordion-content">
        <div class="habit-list">
          <div class="habit-item" data-habit="Beber agua">
            <div class="habit-label">
              <span class="habit-icon">üíß</span>
              <span>Beber agua</span>
            </div>
            <button class="plus-btn">+</button>
          </div>
          <div class="habit-item" data-habit="Comer fruta">
            <div class="habit-label">
              <span class="habit-icon">üçì</span>
              <span>Comer fruta</span>
            </div>
            <button class="plus-btn">+</button>
          </div>
          <div class="habit-item" data-habit="Comer verdura">
            <div class="habit-label">
              <span class="habit-icon">ü•¶</span>
              <span>Comer verdura</span>
            </div>
            <button class="plus-btn">+</button>
          </div>
          <!-- Personalizado -->
          <div class="custom-habit-wrapper">
            <input type="text" class="custom-emoji-input" placeholder="Icono">
            <input type="text" class="custom-habit-input" placeholder="¬°A√±ade el h√°bito que quieras!">
            <button class="custom-habit-btn">A√±adir</button>
          </div>
        </div>
      </div>
    </div>

    <div class="accordion" data-category="deporte">
      <div class="accordion-header">
        <h3>Deporte</h3>
        <span>+</span>
      </div>
      <div class="accordion-content">
        <div class="habit-list">
          <div class="habit-item" data-habit="Caminar">
            <div class="habit-label">
              <span class="habit-icon">üö∂‚Äç‚ôÇÔ∏è</span>
              <span>Caminar</span>
            </div>
            <button class="plus-btn">+</button>
          </div>
          <div class="habit-item" data-habit="Correr">
            <div class="habit-label">
              <span class="habit-icon">üèÉ‚Äç‚ôÇÔ∏è</span>
              <span>Correr</span>
            </div>
            <button class="plus-btn">+</button>
          </div>
          <div class="habit-item" data-habit="Yoga">
            <div class="habit-label">
              <span class="habit-icon">üßò‚Äç‚ôÄÔ∏è</span>
              <span>Yoga</span>
            </div>
            <button class="plus-btn">+</button>
          </div>
          <!-- Personalizado -->
          <div class="custom-habit-wrapper">
            <input type="text" class="custom-emoji-input" placeholder="Icono">
            <input type="text" class="custom-habit-input" placeholder="¬°A√±ade el h√°bito que quieras!">
            <button class="custom-habit-btn">A√±adir</button>
          </div>
        </div>
      </div>
    </div>

    <div class="accordion" data-category="estilo-vida">
      <div class="accordion-header">
        <h3>Estilo de Vida</h3>
        <span>+</span>
      </div>
      <div class="accordion-content">
        <div class="habit-list">
          <div class="habit-item" data-habit="Respiraci√≥n consciente">
            <div class="habit-label">
              <span class="habit-icon">üòÆ‚Äçüí®</span>
              <span>Respiraci√≥n consciente</span>
            </div>
            <button class="plus-btn">+</button>
          </div>
          <div class="habit-item" data-habit="Meditaci√≥n">
            <div class="habit-label">
              <span class="habit-icon">üßò</span>
              <span>Meditaci√≥n</span>
            </div>
            <button class="plus-btn">+</button>
          </div>
          <div class="habit-item" data-habit="Leer un libro">
            <div class="habit-label">
              <span class="habit-icon">üìö</span>
              <span>Leer un libro</span>
            </div>
            <button class="plus-btn">+</button>
          </div>
          <!-- Personalizado -->
          <div class="custom-habit-wrapper">
            <input type="text" class="custom-emoji-input" placeholder="Icono">
            <input type="text" class="custom-habit-input" placeholder="¬°A√±ade el h√°bito que quieras!">
            <button class="custom-habit-btn">A√±adir</button>
          </div>
        </div>
      </div>
    </div>

    <div class="accordion" data-category="tiempo">
      <div class="accordion-header">
        <h3>Planificaci√≥n & Reflexi√≥n</h3>
        <span>+</span>
      </div>
      <div class="accordion-content">
        <div class="habit-list">
          <div class="habit-item" data-habit="Hacer Diario">
            <div class="habit-label">
              <span class="habit-icon">üìù</span>
              <span>Hacer Diario</span>
            </div>
            <button class="plus-btn">+</button>
          </div>
          <div class="habit-item" data-habit="Limpiar la mente">
            <div class="habit-label">
              <span class="habit-icon">üí°</span>
              <span>Limpiar la mente</span>
            </div>
            <button class="plus-btn">+</button>
          </div>
          <div class="habit-item" data-habit="Planificar el d√≠a">
            <div class="habit-label">
              <span class="habit-icon">üóìÔ∏è</span>
              <span>Planificar el d√≠a</span>
            </div>
            <button class="plus-btn">+</button>
          </div>
          <!-- Personalizado -->
          <div class="custom-habit-wrapper">
            <input type="text" class="custom-emoji-input" placeholder="Icono">
            <input type="text" class="custom-habit-input" placeholder="¬°A√±ade el h√°bito que quieras!">
            <button class="custom-habit-btn">A√±adir</button>
          </div>
        </div>
      </div>
    </div>

    <div class="accordion" data-category="dejar">
      <div class="accordion-header">
        <h3>H√°bitos a eliminar</h3>
        <span>+</span>
      </div>
      <div class="accordion-content">
        <div class="habit-list">
          <div class="habit-item" data-habit="Fumar">
            <div class="habit-label">
              <span class="habit-icon">üö≠</span>
              <span>Fumar</span>
            </div>
            <button class="plus-btn">+</button>
          </div>
          <div class="habit-item" data-habit="Comida basura">
            <div class="habit-label">
              <span class="habit-icon">üçî</span>
              <span>Comida basura</span>
            </div>
            <button class="plus-btn">+</button>
          </div>
          <div class="habit-item" data-habit="Bebidas azucaradas">
            <div class="habit-label">
              <span class="habit-icon">üßÉ</span>
              <span>Bebidas azucaradas</span>
            </div>
            <button class="plus-btn">+</button>
          </div>
          <!-- Personalizado -->
          <div class="custom-habit-wrapper">
            <input type="text" class="custom-emoji-input" placeholder="Icono">
            <input type="text" class="custom-habit-input" placeholder="¬°A√±ade el h√°bito que quieras!">
            <button class="custom-habit-btn">A√±adir</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Secci√≥n de Objetivos -->
    <div id="objetivosContainer">
      <h2>Objetivos</h2>
      <div id="objetivosList"></div>
    </div>

    <!-- Bot√≥n Enviar -->
    <button class="send-button" id="btnEnviar">Enviar</button>

    <!-- Mensajes de error -->
    <div id="errorMessages"></div>
  </main>

  <!-- MODAL overlay: mensaje de bienvenida -->
  <div class="modal-overlay" id="welcomeModal">
    <div class="modal-content">

        <!-- Logodel mensaje -->
      <img src="truehabits-logo_TRS.png" alt="TrueHabits Logo">

      <!-- Mensaje llamativo con emojis -->
      <p style="white-space: pre-line;">
        ¬°Hola, bienvenido al formulario de registro! üôå 
        Queremos ayudarte a cumplir con tus objetivos, 
        por m√°s peque√±os que sean. üåü 

        Lo importante es marcar h√°bitos saludables y 
        alcanzables. ¬°M√°s adelante se pueden ampliar! üí™ 

        Recuerda: lo importante es la constancia. üî•
      </p>
      
      <!-- Bot√≥n para cerrar -->
      <button class="close-modal-btn" id="closeModalBtn">Aceptar</button>
    </div>
  </div>

  <script>
    // ===============================================
    // L√≥gica de acordeones
    // ===============================================
    document.querySelectorAll('.accordion').forEach(accordion => {
      const header = accordion.querySelector('.accordion-header');
      const content = accordion.querySelector('.accordion-content');

      // Asigna la categor√≠a a cada .habit-item
      accordion.querySelectorAll('.habit-item').forEach(item => {
        item.dataset.category = accordion.dataset.category || 'otro';
        const iconSpan = item.querySelector('.habit-icon');
        if (iconSpan) {
          item.dataset.icon = iconSpan.textContent.trim();
        } else {
          item.dataset.icon = '‚≠ê';
        }
      });

      // Al hacer click en el encabezado, cierra todos y abre solo el clicado
      header.addEventListener('click', () => {
        const isOpen = content.classList.contains('open');
        document.querySelectorAll('.accordion-content').forEach(ac => {
          ac.classList.remove('open');
          ac.style.maxHeight = null;
        });
        if (!isOpen) {
          content.classList.add('open');
          content.style.maxHeight = content.scrollHeight + 'px';
        }
      });
    });

    // ===============================================
    // L√≥gica de h√°bitos
    // ===============================================
    const MAX_HABITS = 6;
    let selectedCount = 0;
    const objectivesMap = {};

    // Elementos del DOM
    const selectedHabitsList = document.getElementById('selectedHabitsList');
    const objetivosContainer = document.getElementById('objetivosContainer');
    const objetivosList = document.getElementById('objetivosList');
    const btnEnviar = document.getElementById('btnEnviar');
    const errorMessages = document.getElementById('errorMessages');

    // Refrescar la UI
    function refreshUI() {
      updateSelectedHabitsDisplay();
      updateObjectivesDisplay();
      validateInputs();
    }

    // Muestra en pantalla los h√°bitos seleccionados
    function updateSelectedHabitsDisplay() {
      const selectedItems = document.querySelectorAll('.habit-item.selected');
      if (selectedItems.length === 0) {
        selectedHabitsList.textContent = '(¬°Seleccione alg√∫n H√°bito!)';
      } else {
        const arr = [];
        selectedItems.forEach(item => {
          arr.push(item.dataset.habit);
        });
        selectedHabitsList.textContent = arr.join(', ');
      }
    }

    // Objetivos: siempre uno por h√°bito
    function updateObjectivesDisplay() {
      const selectedItems = document.querySelectorAll('.habit-item.selected');
      objetivosList.innerHTML = '';

      if (selectedItems.length === 0) {
        objetivosContainer.style.display = 'none';
        return;
      }
      objetivosContainer.style.display = 'block';

      selectedItems.forEach(item => {
        const habitName = item.dataset.habit;
        if (!objectivesMap[habitName]) {
          objectivesMap[habitName] = { text: '', freq: 'semanal' };
        }

        const row = document.createElement('div');
        row.className = 'objetivo-row';

        const label = document.createElement('label');
        label.textContent = habitName + ':';
        row.appendChild(label);

        const contentDiv = document.createElement('div');
        contentDiv.className = 'objetivo-content';

        const inputObj = document.createElement('input');
        inputObj.type = 'text';
        inputObj.className = 'objetivo-input';
        inputObj.placeholder = "p.ej.: 3 veces al d√≠a // Menos de 5 veces";
        inputObj.value = objectivesMap[habitName].text;
        inputObj.addEventListener('input', () => {
          objectivesMap[habitName].text = inputObj.value;
          validateInputs();
        });
        contentDiv.appendChild(inputObj);

        row.appendChild(contentDiv);

        // Frecuencia
        const freqDiv = document.createElement('div');
        freqDiv.className = 'frequency-row';
        const freqSelect = document.createElement('select');
        freqSelect.className = 'frequency-select';
        freqSelect.innerHTML = `
          <option value="diaria">Diaria</option>
          <option value="semanal">Semanal</option>
          <option value="mensual">Mensual</option>
        `;
        freqSelect.value = objectivesMap[habitName].freq;
        freqSelect.addEventListener('change', () => {
          objectivesMap[habitName].freq = freqSelect.value;
        });
        freqDiv.appendChild(freqSelect);

        row.appendChild(freqDiv);
        objetivosList.appendChild(row);
      });
      validateInputs();
    }

    // Validar campos obligatorios
    function validateInputs() {
      const errors = [];
      const nombre = document.getElementById('nombre').value.trim();
      const edad = document.getElementById('edad').value.trim();
      const selectedItems = document.querySelectorAll('.habit-item.selected');

      if (!nombre) {
        errors.push('- Falta el nombre');
      }
      if (!edad) {
        errors.push('- Falta la edad');
      }
      if (selectedItems.length === 0) {
        errors.push('- Falta al menos un h√°bito');
      }

      // Revisar que cada h√°bito tenga un objetivo no vac√≠o
      selectedItems.forEach(item => {
        const habitName = item.dataset.habit;
        const objText = objectivesMap[habitName].text.trim();
        if (!objText) {
          errors.push(`- Ponga un objetivo para "${habitName}"`);
        }
      });

      if (errors.length === 0) {
        btnEnviar.classList.add('enabled');
        btnEnviar.removeAttribute('disabled');
        btnEnviar.style.backgroundColor = '#f06292';
        btnEnviar.style.cursor = 'pointer';
      } else {
        btnEnviar.classList.remove('enabled');
        btnEnviar.setAttribute('disabled', true);
        btnEnviar.style.backgroundColor = '#ccc';
        btnEnviar.style.cursor = 'not-allowed';
      }

      errorMessages.innerHTML = errors.length > 0 ? errors.join('<br>') : '';
    }

    // Evento para seleccionar/deseleccionar un h√°bito
    document.querySelectorAll('.habit-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.stopPropagation();
        if (!item.classList.contains('selected')) {
          if (selectedCount < MAX_HABITS) {
            item.classList.add('selected');
            selectedCount++;
          } else {
            alert('M√°ximo de 5 h√°bitos alcanzado.');
          }
        } else {
          item.classList.remove('selected');
          selectedCount--;
          delete objectivesMap[item.dataset.habit];
        }
        refreshUI();
      });
    });

    // Evento para a√±adir h√°bito personalizado
    document.querySelectorAll('.custom-habit-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const parent = btn.closest('.habit-list');
        const emojiInput = parent.querySelector('.custom-emoji-input');
        const input = parent.querySelector('.custom-habit-input');
        const customEmoji = emojiInput.value.trim() || '‚≠ê';
        const customName = input.value.trim();

        if (!customName) {
          alert('Ingresa un nombre para el h√°bito.');
          return;
        }
        if (selectedCount >= MAX_HABITS) {
          alert('M√°ximo de 5 h√°bitos alcanzado.');
          return;
        }

        // Crear habit-item
        const newHabit = crearHabitItem(
          parent.closest('.accordion').dataset.category || 'otro',
          customName,
          customEmoji
        );
        newHabit.classList.add('selected');
        selectedCount++;

        parent.insertBefore(newHabit, parent.querySelector('.custom-habit-wrapper'));
        emojiInput.value = '';
        input.value = '';

        refreshUI();
      });
    });

    // Funci√≥n para crear habit-item din√°mico
    function crearHabitItem(category, habitName, icon = "‚≠ê") {
      const newHabit = document.createElement('div');
      newHabit.className = 'habit-item';
      newHabit.dataset.category = category;
      newHabit.dataset.habit = habitName;
      newHabit.dataset.icon = icon;

      newHabit.innerHTML = `
        <div class="habit-label">
          <span class="habit-icon">${icon}</span>
          <span>${habitName}</span>
        </div>
        <button class="plus-btn">+</button>
      `;

      newHabit.addEventListener('click', (ev) => {
        ev.stopPropagation();
        if (!newHabit.classList.contains('selected')) {
          if (selectedCount < MAX_HABITS) {
            newHabit.classList.add('selected');
            selectedCount++;
          } else {
            alert('M√°ximo de 5 h√°bitos alcanzado.');
          }
        } else {
          newHabit.classList.remove('selected');
          selectedCount--;
          delete objectivesMap[newHabit.dataset.habit];
        }
        refreshUI();
      });
      return newHabit;
    }

    // Bot√≥n Enviar
    btnEnviar.addEventListener('click', () => {
      const nombre = document.getElementById('nombre').value.trim();
      const edad = document.getElementById('edad').value.trim();
      const sexo = document.getElementById('sexo').value;
      const selectedItems = document.querySelectorAll('.habit-item.selected');

      // Recopilar h√°bitos
      const habitos = [];
      selectedItems.forEach(item => {
        const cat = item.dataset.category || 'otro';
        const hab = item.dataset.habit;
        const icon = item.dataset.icon || '‚≠ê';
        habitos.push([cat, hab, icon]);
      });

      // Recopilar objetivos
      const objetivos = [];
      selectedItems.forEach(item => {
        const habitName = item.dataset.habit;
        const category = item.dataset.category || 'otro';
        const objText = objectivesMap[habitName].text.trim();
        const freq = objectivesMap[habitName].freq;
        if (objText !== '') {
          objetivos.push([category, habitName, objText, freq]);
        }
      });

      // Construir payload
      const payload = {
        nombre,
        edad,
        sexo,
        habitos,
        objetivos
      };

      // Enviar v√≠a Telegram si est√° disponible
      if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
        Telegram.WebApp.sendData(JSON.stringify(payload));
      }

      console.log('Datos a enviar:', payload);
      alert('¬°Genial, ya est√°s registrado! Ya puedes empezar a utilizar la app ü§©');
    });

    // Muestra el modal de bienvenida
    function mostrarWelcomeModal() {
      const modal = document.getElementById('welcomeModal');
      modal.style.display = 'flex';
    }
    // Oculta el modal
    function ocultarWelcomeModal() {
      const modal = document.getElementById('welcomeModal');
      modal.style.display = 'none';
    }

    // Precarga datos desde query
    function precargarDatosDesdeQuery() {
      const params = new URLSearchParams(window.location.search);
      const dataParam = params.get('data');
      if (!dataParam) return;

      try {
        const data = JSON.parse(decodeURIComponent(dataParam));
        // Rellenar nombre, edad, sexo
        if (data.nombre) document.getElementById('nombre').value = data.nombre;
        if (data.edad)   document.getElementById('edad').value   = data.edad;
        if (data.sexo)   document.getElementById('sexo').value   = data.sexo;

        // Habitos
        const habitos = data.habitos || [];
        habitos.forEach(([cat, hab, icon]) => {
          let selector = `.habit-item[data-category="${cat}"][data-habit="${hab}"]`;
          let item = document.querySelector(selector);
          if (!item) {
            let accordion = document.querySelector(`.accordion[data-category="${cat}"]`);
            if (!accordion) {
              accordion = document.querySelector(`.accordion[data-category="otro"]`);
            }
            const habitList = accordion.querySelector('.habit-list');
            if (!habitList) return;
            item = crearHabitItem(cat, hab, icon || '‚≠ê');
            const customWrapper = habitList.querySelector('.custom-habit-wrapper');
            if (customWrapper) {
              habitList.insertBefore(item, customWrapper);
            } else {
              habitList.appendChild(item);
            }
          }
          if (!item.classList.contains('selected') && selectedCount < MAX_HABITS) {
            item.classList.add('selected');
            selectedCount++;
          }
        });

        // Objetivos
        const objetivos = data.objetivos || [];
        objetivos.forEach(([cat, hab, objText, freq]) => {
          let sel = `.habit-item[data-category="${cat}"][data-habit="${hab}"]`;
          let item = document.querySelector(sel);
          if (!item) {
            let accordion = document.querySelector(`.accordion[data-category="${cat}"]`)
              || document.querySelector(`.accordion[data-category="otro"]`);
            let habitList = accordion.querySelector('.habit-list');
            item = crearHabitItem(cat, hab, "‚≠ê");
            habitList.appendChild(item);
            if (!item.classList.contains('selected') && selectedCount < MAX_HABITS) {
              item.classList.add('selected');
              selectedCount++;
            }
          }
          objectivesMap[hab] = {
            text: objText,
            freq: freq || 'semanal'
          };
        });

      } catch (error) {
        console.error("Error parseando 'data' de la URL:", error);
      }
      refreshUI();
    }

    // Al cargar la p√°gina
    window.addEventListener('DOMContentLoaded', () => {
      // Mostrar el modal de bienvenida
      mostrarWelcomeModal();

      // Bot√≥n para cerrar el modal
      document.getElementById('closeModalBtn').addEventListener('click', ocultarWelcomeModal);

      refreshUI();
      precargarDatosDesdeQuery();
    });
  </script>
</body>
</html>
